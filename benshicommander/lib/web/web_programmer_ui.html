<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIRP Web Programmer</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background-color: #f0f0f0;
            margin: 0;
            padding: 12px 0;
        }
        .main-toolbar {
            background: #e8e8e8;
            border-bottom: 1px solid #bdbdbd;
            padding: 7px 18px 7px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
        }
        .main-toolbar .title {
            font-weight: bold;
            margin-right: 24px;
        }
        .main-toolbar button, .main-toolbar a {
            padding: 3px 12px;
            font-size: 13px;
            margin-right: 3px;
            border: 1px solid #bdbdbd;
            border-radius: 3px;
            background: #f6f6f6;
            cursor: pointer;
            color: #222;
            text-decoration: none;
        }
        .main-toolbar button:hover, .main-toolbar a:hover {
            background: #dbeaff;
            border-color: #5a9dfd;
        }
        .container {
            max-width: 1300px;
            margin: 30px auto 0 auto;
            background-color: #fff;
            border: 1px solid #bbb;
            box-shadow: 0 2px 14px #0001;
            padding: 0;
        }
        .channel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 13px;
            background: #fafbfc;
        }
        .channel-table th, .channel-table td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
            background: #fff;
        }
        .channel-table th {
            background: #e9e9e9;
            color: #222;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .channel-table tr:nth-child(even) td {
            background: #f7f8fa;
        }
        .channel-table tr.selected td {
            background: #dbeaff;
        }
        .channel-table tr:hover td {
            background: #ebf4ff;
        }
        .edit-cell {
            background: #fffbe5 !important;
            border: 1px solid #ffc700 !important;
        }
        .status-bar {
            font-size: 13px;
            color: #666;
            padding: 7px 18px;
            margin-top: 0;
            background: #f3f3f3;
            border-top: 1px solid #ccc;
            text-align: left;
        }
        .status-bar .error { color: #c00; }
        .status-bar .ok { color: #090; }
        .toolbar-btn {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="main-toolbar">
        <span class="title">Benshi Commander <span style="color:#bbb">Web Programmer</span></span>
        <span>Memories</span>
        <label style="margin-left:18px;">Memory Range:</label>
        <input type="number" id="mem-min" value="0" style="width:48px;" min="0">
        <span>&ndash;</span>
        <input type="number" id="mem-max" value="127" style="width:48px;" min="0">
        <button id="refresh-btn" class="toolbar-btn">Refresh</button>
        <a href="/chirp.csv" class="toolbar-btn" download>Download CSV</a>
        <button id="write-btn" class="toolbar-btn">Write to Radio</button>
    </div>
    <div class="container">
        <table class="channel-table">
            <thead>
                <tr>
                    <th>Loc</th>
                    <th>Frequency</th>
                    <th>Name</th>
                    <th>Tone Mode</th>
                    <th>Tone</th>
                    <th>ToneSql</th>
                    <th>DTCS Code</th>
                    <th>DTCS Rx Code</th>
                    <th>DTCS Pol</th>
                    <th>Cross Mode</th>
                    <th>Duplex</th>
                    <th>Offset</th>
                    <th>Mode</th>
                    <th>Power</th>
                    <th>Skip</th>
                </tr>
            </thead>
            <tbody id="channel-table-body"></tbody>
        </table>
    </div>
    <div class="status-bar" id="status">Loading channels from radio...</div>
    <script>
    let channelData = [];
    let editingCell = null;

    function renderTable() {
        const tbody = document.getElementById('channel-table-body');
        tbody.innerHTML = "";
        if (!channelData.length) {
            tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;">No channels found on the radio.</td></tr>';
            return;
        }
        for (let ch of channelData) {
            tbody.innerHTML += `
            <tr data-loc="${ch.location}">
                <td>${ch.location}</td>
                <td>${ch.frequency}</td>
                <td class="editable" data-key="name">${ch.name}</td>
                <td class="editable" data-key="toneMode">${ch.toneMode}</td>
                <td class="editable" data-key="tone">${ch.tone}</td>
                <td class="editable" data-key="toneSql">${ch.toneSql}</td>
                <td class="editable" data-key="dtcsCode">${ch.dtcsCode}</td>
                <td class="editable" data-key="dtcsRxCode">${ch.dtcsRxCode}</td>
                <td>${ch.dtcsPol}</td>
                <td>${ch.crossMode}</td>
                <td class="editable" data-key="duplex">${ch.duplex}</td>
                <td class="editable" data-key="offset">${ch.offset}</td>
                <td class="editable" data-key="mode">${ch.mode}</td>
                <td class="editable" data-key="power">${ch.power}</td>
                <td class="editable" data-key="skip">${ch.skip}</td>
            </tr>`;
        }
    }

    function setStatus(msg, type="info") {
        const status = document.getElementById('status');
        status.textContent = msg;
        status.className = "status-bar " + (type === "error" ? "error" : type === "ok" ? "ok" : "");
    }

    function fetchChannels() {
        setStatus("Loading channels from radio...", "info");
        fetch('/channels.json')
            .then(resp => resp.json())
            .then(data => {
                channelData = data;
                renderTable();
                setStatus("Loaded " + channelData.length + " channels.", "ok");
            })
            .catch(e => {
                setStatus("Could not load channel data. Please try again.", "error");
            });
    }

    // Table cell editing logic
    document.addEventListener('click', function(e) {
        if (editingCell && !editingCell.contains(e.target)) {
            finishEdit();
        }
        if (e.target.classList.contains('editable')) {
            beginEdit(e.target);
        }
    });

    function beginEdit(td) {
        if (editingCell) finishEdit();
        editingCell = td;
        const key = td.dataset.key;
        const loc = td.parentNode.dataset.loc;
        const orig = td.textContent;
        td.classList.add('edit-cell');
        // Use select for some fields, input for others:
        let input;
        if (key === "mode") {
            input = document.createElement('select');
            ["FM","NFM"].forEach(opt => {
                let o = document.createElement('option');
                o.value = o.text = opt;
                if (opt === orig) o.selected = true;
                input.appendChild(o);
            });
        } else if (key === "power") {
            input = document.createElement('select');
            ["Low","Med","High"].forEach(opt => {
                let o = document.createElement('option');
                o.value = o.text = opt;
                if (opt === orig) o.selected = true;
                input.appendChild(o);
            });
        } else if (key === "toneMode") {
            input = document.createElement('select');
            ["(None)","Tone"].forEach(opt => {
                let o = document.createElement('option');
                o.value = o.text = opt;
                if (opt === orig) o.selected = true;
                input.appendChild(o);
            });
        } else if (key === "duplex") {
            input = document.createElement('select');
            ["(None)","+","-"].forEach(opt => {
                let o = document.createElement('option');
                o.value = o.text = opt;
                if (opt === orig) o.selected = true;
                input.appendChild(o);
            });
        } else if (key === "skip") {
            input = document.createElement('select');
            ["","S"].forEach(opt => {
                let o = document.createElement('option');
                o.value = o.text = opt;
                if (opt === orig) o.selected = true;
                input.appendChild(o);
            });
        } else {
            input = document.createElement('input');
            input.type = "text";
            input.value = orig;
            input.style.width = Math.max(48, orig.length*8) + "px";
        }
        input.addEventListener('keydown', function(ev) {
            if (ev.key === "Enter") finishEdit();
            if (ev.key === "Escape") cancelEdit();
        });
        input.addEventListener('blur', finishEdit);
        td.textContent = '';
        td.appendChild(input);
        input.focus();
    }

    function finishEdit() {
        if (!editingCell) return;
        const input = editingCell.querySelector('input,select');
        if (!input) return;
        const val = input.value;
        const key = editingCell.dataset.key;
        const row = editingCell.parentNode;
        const loc = +row.dataset.loc;
        // Update channelData
        const idx = channelData.findIndex(ch => ch.location == loc);
        if (idx >= 0) channelData[idx][key] = val;
        editingCell.textContent = val;
        editingCell.classList.remove('edit-cell');
        // Save to backend
        const ch = Object.assign({}, channelData[idx]);
        fetch('/channels/update', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(ch)
        }).then(resp => resp.json())
          .then(resp => setStatus("Channel " + loc + " updated.", "ok"))
          .catch(e => setStatus("Could not update channel " + loc, "error"));
        editingCell = null;
    }

    function cancelEdit() {
        if (!editingCell) return;
        editingCell.textContent = editingCell.dataset.orig;
        editingCell.classList.remove('edit-cell');
        editingCell = null;
    }

    // Toolbar functions
    document.getElementById('refresh-btn').onclick = fetchChannels;
    document.getElementById('write-btn').onclick = function() {
        setStatus("Write to Radio is not yet implemented in this version.", "info");
        // To be implemented with Benshi backend later!
    };

    // Range filter logic (future)
    document.getElementById('mem-min').addEventListener('change', function() {
        // Could filter table, for now just UI
    });
    document.getElementById('mem-max').addEventListener('change', function() {
        // Could filter table, for now just UI
    });

    fetchChannels();
    </script>
</body>
</html>